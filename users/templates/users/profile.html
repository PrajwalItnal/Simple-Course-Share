{% extends 'base.html' %}

{% block title %}User Profile{% endblock %}

{% block content %}
    <div>
        <header>
            <a href="{% url 'users:course_list' username=user.username %}">Return to Course List</a>
        </header>
    </div>
    <div>
        <div>
            <h1>Hello {{ profile_user.user.username }}</h1>
            {% if profile_user.bio %}
                <p>{{ profile_user.bio }}</p>
            {% else %}
                <p>No bio available.</p>
            {% endif %}
        </div>

        {% if profile_user.is_student %}
            <div>
                <h3>My Learning Journey</h3>
                {% if profile_user.saved_courses.all %}
                    <ul id="saved-courses-list">
                        {% for course in profile_user.saved_courses.all %}
                            <li id="std-course-id-{{ course.id }}">
                                <p><strong>{{ course.title }}</strong></p>
                                <div class="video-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; margin: 15px 0; background: #000; border-radius: 8px;">
                                    <iframe 
                                        src="{{ course.replace_youtube_link }}" 
                                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                        referrerpolicy="strict-origin-when-cross-origin"
                                        allowfullscreen>
                                    </iframe>
                                </div>
                                <p>{{ course.description }}</p>
                                <button 
                                    onclick="unsaveCourse(this, {{ course.id }})" 
                                    data-url="{% url 'users:unsave_course' course_id=course.id %}"
                                    style="background-color: #ff4757; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                    üóëÔ∏è Unsave Course
                                </button>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No saved courses.</p>
                {% endif %}
            </div>
        {% else %}
            {% if messages %}
                <div class="container mt-3">
                    {% for message in messages %}
                        <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
            <div>
                <h2>Published Courses</h2>
                {% if profile_user.published_courses.all %}
                    <ul id ="published-courses-list">
                        {% for course in profile_user.published_courses.all %}
                            <li id = "pub-course-id-{{ course.id }}">
                                <h4>{{ course.title }}</h4>
                                <div class="video-wrapper" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 10px; background: #000;">
                                    <iframe 
                                        src="{{ course.replace_youtube_link }}" 
                                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                        referrerpolicy="strict-origin-when-cross-origin"
                                        allowfullscreen>
                                    </iframe>
                                </div>
                                <button
                                onclick = "unsaveCourse(this, {{ course.id }})"
                                data-url = "{% url 'users:unsave_course' course_id=course.id %}"
                                style="background-color: #ff4757; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;">
                                üóëÔ∏è Delete Course
                                </button>
                                <p>{{ course.description }}</p>
                                <p><i>{{ course.created_at }}</i></p>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No published courses.</p>
                {% endif %}
            </div>
            <button><a href="{% url 'users:upload_course' %}">upload course</a></button>
        {% endif %}
    </div>

    <div>
        <form method="POST" action="{% url 'users:logout' %}">
            {% csrf_token %}
            <button type="submit" class="logout-btn">Logout</button>
        </form>
    </div>

    <script>
        function unsaveCourse(button, courseId) {
            const url = button.getAttribute('data-url');
            const isStudent = {{ profile_user.is_student|yesno:"true,false" }};
            const actionWord = isStudent ? 'unsave' : 'delete';

            if(!confirm(`Are you sure you want to ${actionWord} this course?`)) {
                return;
            }

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'X-Requested-With': 'XMLHttpRequest'
                },
            })
            .then(response => response.json())
            .then(data => {
                let list;
                let courseElement;
                if (isStudent) {
                    list = document.getElementById('saved-courses-list');
                    courseElement = document.getElementById('std-course-id-' + courseId);
                } else {
                    list = document.getElementById('published-courses-list');
                    courseElement = document.getElementById('pub-course-id-' + courseId);
                }
                if(data.status === 'success') {
                    courseElement.style.transition = 'opacity 0.5s ease-out';
                    courseElement.style.opacity = 0;
                    
                    setTimeout(() => {
                        courseElement.remove();
                        
                        if (list && list.children.length === 0) {
                            location.reload(); // Reload to show the "No saved courses" text
                        }
                    }, 500);
                } else {
                    alert(`Error ${actionWord}ing course.`);
                }
            })
            .catch(error => console.error('Error:', error));
        }
    </script>
{% endblock %}