{% extends 'base.html' %}
{% load static %}

{% block title %}User Profile{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/profile.css' %}">
{% endblock %}

{% block content %}
<div class="profile-wrapper">
    <div class="profile-header">
        <a href="{% url 'users:course_list' username=user.username %}" class="back-link">
            â† Return to Courses
        </a>
    </div>

    <div class="profile-container">
        <section class="profile-intro">
            <div class="profile-info">
                <h1 class="profile-name">{{ profile_user.user.username }}</h1>
                <p class="profile-bio">
                    {% if profile_user.bio %}
                        {{ profile_user.bio }}
                    {% else %}
                        <span class="no-bio">No bio available.</span>
                    {% endif %}
                </p>
            </div>
        </section>

        {% if profile_user.is_student %}
            <!-- Student Section -->
            <section class="courses-section student-section">
                <h2 class="section-title">ğŸ“š My Learning Journey</h2>
                
                {% if profile_user.saved_courses.all %}
                    <ul id="saved-courses-list" class="courses-list">
                        {% for course in profile_user.saved_courses.all %}
                            <li id="std-course-id-{{ course.id }}" class="course-card">
                                <div class="course-header">
                                    <h3 class="course-title">{{ course.title }}</h3>
                                </div>
                                
                                <div class="video-container">
                                    <iframe 
                                        src="{{ course.replace_youtube_link }}" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                        referrerpolicy="strict-origin-when-cross-origin"
                                        allowfullscreen>
                                    </iframe>
                                </div>
                                
                                <p class="course-description">{{ course.description }}</p>
                                
                                <button 
                                    class="btn btn-unsave"
                                    onclick="unsaveCourse(this, {{ course.id }})" 
                                    data-url="{% url 'users:unsave_course' course_id=course.id %}">
                                    ğŸ—‘ï¸ Unsave Course
                                </button>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="no-courses">No saved courses yet. Start exploring!</p>
                {% endif %}
            </section>

        {% else %}
            <!-- Publisher Section -->
            {% if messages %}
                <div class="messages-container">
                    {% for message in messages %}
                        <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-{{ message.tags }}{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <section class="courses-section publisher-section">
                <div class="section-header">
                    <h2 class="section-title">ğŸ¬ Published Courses</h2>
                    <a href="{% url 'users:upload_course' %}" class="btn btn-upload">
                        + Upload Course
                    </a>
                </div>

                {% if profile_user.published_courses.all %}
                    <ul id="published-courses-list" class="courses-list">
                        {% for course in profile_user.published_courses.all %}
                            <li id="pub-course-id-{{ course.id }}" class="course-card">
                                <div class="course-header">
                                    <h3 class="course-title">{{ course.title }}</h3>
                                    <small class="course-date">{{ course.created_at|date:"M d, Y" }}</small>
                                </div>
                                
                                <div class="video-container">
                                    <iframe 
                                        src="{{ course.replace_youtube_link }}" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                        referrerpolicy="strict-origin-when-cross-origin"
                                        allowfullscreen>
                                    </iframe>
                                </div>
                                
                                <p class="course-description">{{ course.description }}</p>
                                
                                <button
                                    class="btn btn-delete"
                                    onclick="unsaveCourse(this, {{ course.id }})"
                                    data-url="{% url 'users:unsave_course' course_id=course.id %}">
                                    ğŸ—‘ï¸ Delete Course
                                </button>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="no-courses">No published courses yet. Start sharing your knowledge!</p>
                {% endif %}
            </section>
        {% endif %}

        <section class="logout-section">
            <form method="POST" action="{% url 'users:logout' %}" class="logout-form">
                {% csrf_token %}
                <button type="submit" class="btn btn-logout">Logout</button>
            </form>
        </section>
    </div>
</div>

<script>
    function unsaveCourse(button, courseId) {
        const url = button.getAttribute('data-url');
        const isStudent = {{ profile_user.is_student|yesno:"true,false" }};
        const actionWord = isStudent ? 'unsave' : 'delete';

        if(!confirm(`Are you sure you want to ${actionWord} this course?`)) {
            return;
        }

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
        })
        .then(response => response.json())
        .then(data => {
            let list;
            let courseElement;
            if (isStudent) {
                list = document.getElementById('saved-courses-list');
                courseElement = document.getElementById('std-course-id-' + courseId);
            } else {
                list = document.getElementById('published-courses-list');
                courseElement = document.getElementById('pub-course-id-' + courseId);
            }
            if(data.status === 'success') {
                courseElement.style.transition = 'opacity 0.5s ease-out';
                courseElement.style.opacity = 0;
                
                setTimeout(() => {
                    courseElement.remove();
                    
                    if (list && list.children.length === 0) {
                        location.reload();
                    }
                }, 500);
            } else {
                alert(`Error ${actionWord}ing course.`);
            }
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}