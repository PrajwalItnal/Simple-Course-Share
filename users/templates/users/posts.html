{% extends 'base.html' %}
{% load static %}

{% block title %}Course Posts{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/courses.css' %}">
{% endblock %}

{% block content %}
<div class="courses-wrapper">
    <!-- Header -->
    <header class="courses-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="header-title">Hello, {{ user.username }} ðŸ‘‹</h1>
                <p class="header-subtitle">Explore and learn from amazing courses</p>
            </div>
            <div class="header-right">
                <a href="{% url 'users:profile' username=user.username %}" class="btn btn-secondary">
                    Profile
                </a>
                <form method="POST" action="{% url 'users:logout' %}" class="logout-form">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-logout">Logout</button>
                </form>
            </div>
        </div>
    </header>

    <div class="courses-container">
        <!-- Section Title -->
        <div class="section-header">
            {% if courses|length %}
                <h2 class="section-title">ðŸ“š Available Courses ({{ courses|length }})</h2>
            {% else %}
                <h2 class="section-title">ðŸ“š No Courses Available</h2>
            {% endif %}
        </div>

        <!-- Courses Grid -->
        {% if courses|length %}
            <div class="courses-grid">
                {% for course in courses %}
                    <div class="course-item" id="course-{{ course.id }}">
                        <!-- Course Card Header -->
                        <div class="course-publisher">
                            <span class="publisher-name">By {{ course.publisher.user.username }}</span>
                            <span class="course-date">{{ course.created_at|date:"M d, Y" }}</span>
                        </div>

                        <!-- Course Title -->
                        <h3 class="course-title">{{ course.title }}</h3>

                        <!-- Video Container -->
                        <div class="video-container">
                            <iframe 
                                src="{{ course.replace_youtube_link }}" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                referrerpolicy="strict-origin-when-cross-origin"
                                allowfullscreen>
                            </iframe>
                        </div>

                        <!-- Course Description -->
                        <p class="course-description">{{ course.description }}</p>

                        <!-- Action Buttons -->
                        <div class="course-actions">
                            {% if user.profile.is_student %}
                                <button 
                                    id="btn-save-{{ course.id }}" 
                                    class="btn btn-save {% if course in user.profile.saved_courses.all %}btn-saved{% endif %}"
                                    onclick="saveCourse(this, {{ course.id }})"
                                    data-url="{% url 'users:save_course' course_id=course.id %}"
                                    {% if course in user.profile.saved_courses.all %}disabled{% endif %}>
                                    {% if course in user.profile.saved_courses.all %}
                                        âœ“ Course Saved
                                    {% else %}
                                        ðŸ’¾ Save Course
                                    {% endif %}
                                </button>
                            {% endif %}
                            <a href="{{ course.video_url }}" target="_blank" class="btn btn-youtube">
                                â–¶ Watch on YouTube
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon">ðŸ“­</div>
                <h3>No Courses Yet</h3>
                <p>Check back soon for amazing courses from our publishers!</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
    function saveCourse(button, courseId) {
        const saveUrl = button.getAttribute('data-url');
        
        fetch(saveUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
        })
        .then(response => {
            if (response.ok) {
                button.disabled = true;
                button.textContent = 'âœ“ Course Saved';
                button.classList.add('btn-saved');
                button.classList.remove('btn-save');
            } else {
                alert('Error saving course.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving course.');
        });
    }
</script>
{% endblock %}